#!/usr/bin/perl -l 

#***************************************************************************************************
#
# TDL Parser, creates CSV file from input TDL pattern file
# 
# SYNTAX : tdl2csv <input filename> [<output filename>]
#
# Created by : Kartik Shenoy (a0393831)
#
# Changelog
#
# 2009-12-18
#   - Created
#
#***************************************************************************************************


use strict;
use diagnostics;
use constant DEBUG=>0;

if($#ARGV == -1){
	print "ERROR : Enter the name of the input file. Output filename may also be specified explicitly.";
	exit(1);
}elsif($#ARGV == 0){
	print "WARNING : Output file not specified. Writing the output to $ARGV[0]_tdlout.csv";
	open FOUT, ">${ARGV[0]}_tdlout.csv";
}elsif($#ARGV == 1){
	$ARGV[1]=~s/\.csv$//;
	open FOUT, ">${ARGV[1]}.csv";
}else{
	print "WARNING : More than 2 arguments specified. Ignoring all arguments after the 2nd";
}

open FIN, "<$ARGV[0]" or die "ERROR : Specified input file doesn't exist. Terminating";

my $pin_names="";
my $flag=0;
while(<FIN>){
	next unless(/^\s*VAR/||$flag);
	$flag=1;
	s/.*?"//;
	s/[\"\s]//g;
	$pin_names .= $_;
	last if(/\),\s*$/);
}
$pin_names=~s/\)//;
print FOUT $pin_names;
print $pin_names if DEBUG==1;

{
	$/=";";

	my $line;
	my $line_repeat=1;
	while(<FIN>){
		s/[_\n]//g;
		if(/SETR P:=T\'([01YZLHM]*)/){
			$line = $1;
			$line =~ s/(.)/$1,/g;
			print $line if DEBUG==1;
			print FOUT $line;
		}
		if(/RUNP FOR (\d*)/){
			$line_repeat=$1;
			print $line_repeat if DEBUG==1;
			for(my $i=0;$i++<$line_repeat;){
				print FOUT $line;
			}
		}
	}
}
